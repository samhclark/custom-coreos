variant: fcos
version: 1.6.0
passwd:
  users:
    - name: core
      password_hash: $y$j9T$7GtjANV1qrO4LeF.nq64X0$1QXVMdBf5i45EykXQkj7yGxbX/NTrW4Fbqowj3XEtI6
      ssh_authorized_keys:
        - ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCXLMgaiwxwbRJPfOAqiZ1xdvxp8yprodU8mi72BUnqX62x1OFWKxTJf44Sej/Hm8JyOquVTtRXKiveJOSsV2Ws=

storage:
  luks:
    - name: root
      label: luks-root
      device: /dev/disk/by-partlabel/root
      clevis:
        custom:
          needs_network: false
          pin: tpm2
          config: '{"pcr_bank":"sha256","pcr_ids":"7"}'
      wipe_volume: true

  filesystems:
    - device: /dev/mapper/root
      format: btrfs
      wipe_filesystem: true
      label: root

  files:
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: nas
    
    # Rootful Cockpit Web Service Quadlet
    - path: /etc/containers/systemd/cockpit-ws.container
      contents:
          inline: |
            [Unit]
            Description=Cockpit Web Service
            Wants=network-online.target
            After=network-online.target

            [Container]
            ContainerName=cockpit-ws
            Image=quay.io/cockpit/ws:latest
            AutoUpdate=registry
            PublishPort=127.0.0.1:9090:9090
            Pull=always

            [Service]
            Restart=always

            [Install]
            WantedBy=multi-user.target default.target

systemd:
  units:
    # Enable ZFS snapshots for datasets
    - name: zfs-snapshots-frequently@videos.timer
      enabled: true
    - name: zfs-snapshots-hourly@videos.timer
      enabled: true
    - name: zfs-snapshots-daily@videos.timer
      enabled: true
    - name: zfs-snapshots-weekly@videos.timer
      enabled: true
    - name: zfs-snapshots-monthly@videos.timer
      enabled: true
    - name: zfs-snapshots-yearly@videos.timer
      enabled: true

    # Enable ZFS health monitoring
    - name: zfs-health-check.timer
      enabled: true
    - name: zfs-scrub.timer
      enabled: true
