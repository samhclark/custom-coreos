name: Generate and Deploy Ignition Files

on:
  push:
    branches: [ main ]
    paths: 
      - 'butane.yaml'
      - '.github/workflows/pages.yaml'
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-ignition:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      
      - name: Generate Ignition file from Butane config
        run: |
          echo "ðŸ”§ Generating Ignition file from butane.yaml..."
          
          # Generate Ignition JSON using Butane container
          podman run --rm --interactive \
            --security-opt label=disable \
            --volume "${PWD}":/pwd --workdir /pwd \
            quay.io/coreos/butane:release < butane.yaml > ignition.json
          
          echo "âœ… Generated ignition.json ($(wc -c < ignition.json) bytes)"
          
          # Create a simple index.html for the GitHub Pages site
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Custom CoreOS Ignition Files</title>
              <meta charset="utf-8">
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .file { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                  code { background: #f5f5f5; padding: 2px 4px; border-radius: 3px; }
                  pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
              </style>
          </head>
          <body>
              <h1>Custom CoreOS Ignition Files</h1>
              <p>Automatically generated Ignition files for CoreOS installation.</p>
              
              <div class="file">
                  <h2>Ignition Configuration</h2>
                  <p><strong>File:</strong> <a href="ignition.json">ignition.json</a></p>
                  <p><strong>Usage:</strong> Use this URL during CoreOS installation:</p>
                  <pre><code>https://samhclark.github.io/custom-coreos/ignition.json</code></pre>
                  <p><strong>Generated:</strong> $(date -u)</p>
                  <p><strong>Size:</strong> $(wc -c < ignition.json) bytes</p>
              </div>
              
              <div class="file">
                  <h2>Features</h2>
                  <ul>
                      <li>LUKS encrypted root filesystem with TPM2 unlock</li>
                      <li>Btrfs root filesystem</li>
                      <li>SSH key configuration for 'core' user</li>
                      <li>Hostname set to 'nas'</li>
                  </ul>
              </div>
              
              <div class="file">
                  <h2>Installation</h2>
                  <p>Use this Ignition file during CoreOS installation by providing the URL above.</p>
                  <p>The configuration will automatically set up encrypted storage with TPM2-based unlocking.</p>
              </div>
          </body>
          </html>
          EOF
          
          echo "âœ… Generated index.html"
          
      - name: Setup Pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: '.'
          
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: generate-ignition
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5